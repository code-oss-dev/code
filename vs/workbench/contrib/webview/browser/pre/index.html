<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%;">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="Content-Security-Policy"
		content="default-src *; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Virtual Document</title>
</head>

<body style="margin: 0; overflow: hidden; width: 100%; height: 100%">
	<script src="main.js"></script>
	<script>
		(function () {
			const id = document.location.search.match(/\bid=([\w\-]+)/)[1];

			const hostMessaging = new class HostMessaging {
				constructor() {
					this.handlers = new Map();
					window.addEventListener('message', (e) => {
						if (e.data && (e.data.command === 'onmessage' || e.data.command === 'do-update-state')) {
							// Came from inner iframe
							this.postMessage(e.data.command, e.data.data);
							return;
						}

						const channel = e.data.channel;
						const handler = this.handlers.get(channel);
						if (handler) {
							handler(e, e.data.args);
						} else {
							console.log('no handler for ', e);
						}
					});
				}

				postMessage(channel, data) {
					window.parent.postMessage({ target: id, channel, data }, '*');
				}

				onMessage(channel, handler) {
					this.handlers.set(channel, handler);
				}
			}();

			const workerReady = new Promise(async (resolveWorkerReady) => {
				if (!navigator.serviceWorker) {
					resolveWorkerReady();
				}

				const expectedWorkerVersion = 1;

				navigator.serviceWorker.register('service-worker.js').then(async registration => {
					await navigator.serviceWorker.ready;

					const versionHandler = (event) => {
						if (event.data.channel !== 'version') {
							return;
						}

						navigator.serviceWorker.removeEventListener('message', versionHandler);
						if (event.data.version === expectedWorkerVersion) {
							return resolveWorkerReady();
						} else {
							console.log('Wrong version')
							// If we have the wrong version, try once to unregister and re-register
							return registration.unregister()
								.then(() => navigator.serviceWorker.register('service-worker.js'))
								.then(navigator.serviceWorker.ready)
								.finally(resolveWorkerReady);
						}
					};
					navigator.serviceWorker.addEventListener('message', versionHandler);
					registration.active.postMessage({ channel: 'version' });
				});

				const forwardFromHostToWorker = (channel) => {
					hostMessaging.onMessage(channel, event => {
						navigator.serviceWorker.ready.then(registration => {
							registration.active.postMessage({ channel: channel, data: event.data.args });
						});
					});
				}
				forwardFromHostToWorker('did-load-resource');
				forwardFromHostToWorker('did-load-localhost');

				navigator.serviceWorker.addEventListener('message', event => {
					if (['load-resource', 'load-localhost'].includes(event.data.channel)) {
						hostMessaging.postMessage(event.data.channel, event.data);
					}
				});
			});

			createWebviewManager({
				postMessage: hostMessaging.postMessage.bind(hostMessaging),
				onMessage: hostMessaging.onMessage.bind(hostMessaging),
				ready: workerReady,
			});
		}());
	</script>
</body>

</html>