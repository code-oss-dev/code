steps:
- task: NodeTool@0
  inputs:
    versionSpec: "8.12.0"

- task: DownloadPipelineArtifact@0
  displayName: 'Download Pipeline Artifact'
  inputs:
    artifactName: snap
    targetPath: .build/linux/snap

- script: |
    set -e
    REPO="$(pwd)"
    ROOT="$REPO/.."
    ARCH="$(VSCODE_ARCH)"

    BUILDNAME="VSCode-linux-$ARCH"
    BUILD="$ROOT/$BUILDNAME"
    BUILD_VERSION="$(date +%s)"
    SNAP_FILENAME="code-$VSCODE_QUALITY-$BUILD_VERSION.snap"
    PACKAGEJSON="$BUILD/resources/app/package.json"
    VERSION=$(node -p "require(\"$PACKAGEJSON\").version")

    SNAP_ROOT="$REPO/.build/linux/snap/$ARCH"
    SNAP_PATH="$SNAP_ROOT/$SNAP_FILENAME"

    (cd "$SNAP_ROOT/*" ; snapcraft -o "$SNAP_PATH")

    AZURE_DOCUMENTDB_MASTERKEY="$(AZURE_DOCUMENTDB_MASTERKEY)" \
    AZURE_STORAGE_ACCESS_KEY_2="$(AZURE_STORAGE_ACCESS_KEY_2)" \
    MOONCAKE_STORAGE_ACCESS_KEY="$(MOONCAKE_STORAGE_ACCESS_KEY)" \
    node build/tfs/common/publish.js "$VSCODE_QUALITY" "linux-snap-$ARCH" package "$SNAP_FILENAME" "$VERSION" true "$SNAP_PATH"